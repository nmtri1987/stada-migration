RBVH.Stada.javascript.common.NamespaceManager.register("RBVH.Stada.WebPages.pages");RBVH.Stada.WebPages.pages.ShiftRequest=function(n){this.Protocol=window.location.protocol;this.Settings={ServiceUrls:{DepartmentList:this.Protocol+"//{0}/_vti_bin/Services/Department/DepartmentService.svc/GetDepartmentForShift/{1}/{2}",ShiftTimeList:this.Protocol+"//{0}/_vti_bin/Services/ShiftTime/ShiftTimeService.svc/GetShiftTimes",ShiftRequestList:this.Protocol+"//{0}/_vti_bin/Services/ShiftManagement/ShiftManagementService.svc/GetByPreviousShift",ShiftRequestGet:this.Protocol+"//{0}/_vti_bin/Services/ShiftManagement/ShiftManagementService.svc/GetShiftManagementById/{1}",ShiftRequestExport:this.Protocol+"//{0}/_vti_bin/Services/ShiftManagement/ShiftManagementService.svc/ExportShifts",CalendarList:this.Protocol+"//{0}/_vti_bin/Services/Calendar/CalendarService.svc/GetHolidayInRange/{1}/{2}",UserInformation:this.Protocol+"//{0}/_vti_bin/Services/Employee/EmployeeService.svc/GetCurrentUser",Approvers:this.Protocol+"//{0}/_vti_bin/Services/Employee/EmployeeService.svc/GetEmployeeApprovers/{1}",LeavesByDepartment:this.Protocol+"//{0}/_vti_bin/Services/leavemanagement/leavemanagementservice.svc/GetLeavesInRangeByDepartment/{1}/{2}/{3}/{4}",ImportFile:this.Protocol+"//{0}/_vti_bin/Services/ShiftManagement/ShiftManagementService.svc/ImportShifts/{1}/{2}/{3}/{4}/{5}",IsDelegated:this.Protocol+"//{0}/_vti_bin/Services/ShiftManagement/ShiftManagementService.svc/IsDelegated/{1}/{2}",ShiftManagementMasterDetailInsert:this.Protocol+"//{0}/_vti_bin/Services/ShiftManagement/ShiftManagementService.svc/InsertShiftManagementMasterDetail",ShiftManagementDetailApprove:this.Protocol+"//{0}/_vti_bin/Services/ShiftManagement/ShiftManagementService.svc/ApproveShiftManagementDetail",ShiftManagementSendAdminApprovalEmail:this.Protocol+"//{0}/_vti_bin/Services/ShiftManagement/ShiftManagementService.svc/SendAdminApprovalEmail",GetConfigurations:"//{0}/_vti_bin/Services/Configurations/ConfigurationsService.svc/GetConfigurations"},ShiftImportReturnUrl:this.Protocol+"//{0}/SitePages/ShiftRequest.aspx?subSection=ShiftManagement&itemid={1}&Source={2}",Configurations:{},ConfigKey_ValidInputDate:"ShiftForm_ValidInputDate",Id:n.Id,View:n.View,ISODateFormat:"{0}-{1}-{2}",BeginDate:21,EndDate:20,MaxDate:31,DaysInMonth:30,CurrentMonth:3,CurrentYear:2017,StartDateRange:"",EndDateRange:"",ShiftTimes:[{Name:"",Id:0},{Name:"Ca 1",Id:1},{Name:"Ca 2",Id:2},{Name:"Ca 3",Id:3}],ShiftTimeCodes:[],Requester:{Id:0,Name:"",DepartmentId:0,LocationId:0},ApprovedBy:{UserName:"",FullName:""},NonWorkingDays:[],NonWorkingDaysNM1:[],NonWorkingDaysNM2:[],StartIndex:2,Start1StDateIndex:13,EmployeeJsonArray:[],ShiftManagementId:0,ShiftManagementDataSource:[],Grid:{CustomFields:{ShiftTimeField:null}},ShaderCssClass:".jsgrid-load-shader",LoadPanelCssClass:".jsgrid-load-panel",Fields:[],ReadOnlyGrid:!1,DepartmentId:0,LocationId:0,LocationName:"",IsSystemAdmin:!1,ItemBeforeEdit:null,ItemAfterEdit:null,GridBeforeEdit:null,LeavesByDepartmentArray:[],ModifiedBy:null,ApproverFullName:"",RequestDueDate:"",RequestExpired:!1};$.extend(!0,this.Settings,n);this.Initialize()};RBVH.Stada.WebPages.pages.ShiftRequest.prototype={Initialize:function(){var n=this,t,i;n.Settings.Id=RBVH.Stada.WebPages.Utilities.GetValueByParam("itemId");t=RBVH.Stada.WebPages.Utilities.GetValueByParam("Source");t=!t?document.referrer:decodeURIComponent(t);n.Settings.PrevURL=t;i=RBVH.Stada.WebPages.Utilities.GetValueByParam("Mode");i&&i.toUpperCase()=="EDIT"?n.Settings.View="Edit":i&&i.toUpperCase()=="VIEW"&&(n.Settings.View="View");SP.SOD.executeFunc("SP.js","SP.ClientContext",function(){n.GetConfigurations();n.InitControls();n.SetDefaultValue();n.PopulateData();n.RegisterEvents()})},GetConfigurations:function(){var n=this,t=[n.Settings.ConfigKey_ValidInputDate],i=RBVH.Stada.WebPages.Utilities.String.format(n.Settings.ServiceUrls.GetConfigurations,location.host);$.ajax({type:"POST",url:i,data:JSON.stringify(t),cache:!1,async:!1,contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(t){t&&t.length>0&&(n.Settings.Configurations=t)})},RegisterEvents:function(){var n=this;$(n.Settings.MonthControlSelector).on("changeDate",function(t){var o,r,f,i;n.Settings.EmployeeJsonArray.length>0&&!n.CheckIsDirty()&&(o=confirm(n.Settings.SaveCurrentDataConfirmMessage),o==!0?n.OnSaveData():n.Settings.EmployeeJsonArray=[]);r=1;try{f=Functions.getConfigValue(n.Settings.Configurations,n.Settings.ConfigKey_ValidInputDate);f&&(r=parseInt(f))}catch(l){r=1}var e=new Date,c=e.getDate()+r,s=e.getMonth(),h=e.getYear()+1900,u=t.date.getMonth();n.Settings.CurrentMonth=u+1;i=t.date.getYear()+1900;n.Settings.CurrentYear=i;n.Settings.ReadOnlyGrid=!1;n.Settings.View=="Approval"||(i<h?n.Settings.ReadOnlyGrid=!0:i==h&&(u<s?n.Settings.ReadOnlyGrid=!0:u==s&&c>20&&(n.Settings.ReadOnlyGrid=!0)));n.Settings.DaysInMonth=new Date(i,u,0).getDate();$(".datepicker").hide();n.CalculateDateRange();n.GetNonWorkingDays();n.PopulateLeavesByDepartment();$(n.Settings.GridEmployeeControlSelector).jsGrid("destroy");n.PopulateGrid()});$(n.Settings.DepartmentControlSelector).on("change",function(){if(n.Settings.DepartmentId=$(this).val(),n.Settings.EmployeeJsonArray.length>0){var t=confirm(n.Settings.SaveCurrentDataConfirmMessage);t==!0?n.OnSaveData():n.Settings.EmployeeJsonArray=[]}$(n.Settings.GridEmployeeControlSelector).jsGrid("loadData")});$(n.Settings.SaveControlSelector).click(function(){return n.OnSaveData(),!1});$(n.Settings.ExportControlSelector).click(function(){return n.Settings.ShiftManagementId&&n.Settings.ShiftManagementId>0&&(url=RBVH.Stada.WebPages.Utilities.String.format(n.Settings.ServiceUrls.ShiftRequestExport,location.host)+"/"+n.Settings.ShiftManagementId,window.location=url),!1});$(n.Settings.CancelControlSelector).click(function(){return window.location=n.Settings.PrevURL,!1});$(n.Settings.FileSelector).on("change",function(){$(n.Settings.ImportControlSelector).removeAttr("disabled");$(n.Settings.ImportControlSelector).removeClass("disable")});$(n.Settings.ImportControlSelector).on("click",function(t){$(".se-pre-con").fadeIn(0);n.OnUploadFileData();t.preventDefault()})},OnUploadFileData:function(){function i(t){function s(){var n=jQuery.Deferred(),t=new FileReader;return t.onloadend=function(t){n.resolve(t.target.result)},t.onerror=function(t){n.reject(t.target.error)},t.readAsArrayBuffer(r[0].files[0]),n.promise()}function h(n){var f=r[0].value.split("\\"),t=i,u=String.format("{0}/_api/web/getfolderbyserverrelativeurl('{1}')/files/add(overwrite=true, url='{2}')",e,o,t);return jQuery.ajax({url:u,type:"POST",data:n,processData:!1,headers:{accept:"application/json;odata=verbose","X-RequestDigest":jQuery("#__REQUESTDIGEST").val(),"content-length":n.byteLength}})}function c(n){return jQuery.ajax({url:n,type:"GET",headers:{accept:"application/json;odata=verbose"}})}var o="/Shared%20Documents",r=$("#ShiftFileUpload"),i="",f,e,u;if(r&&r[0].files[0])i=r[0].files[0].name.toString();else{alert(t.Settings.InputFileErrorMessage);$(".se-pre-con").fadeOut(0);return}i!=""&&(f=(new Date).format("mdyhms"),i=f+i,e=_spPageContextInfo.webAbsoluteUrl,u=s(),u.done(function(r){var u=h(r);u.done(function(r){var u=c(r.d.ListItemAllFields.__deferred.uri);u.done(function(){t.ProcessUploading(i)});u.fail(n)});u.fail(n)}),u.fail(n))}function n(n){alert(n.responseText)}var t=this;i(t)},ProcessUploading:function(n){if(n){var t=this,i=RBVH.Stada.WebPages.Utilities.String.format(t.Settings.ServiceUrls.ImportFile,location.host,t.Settings.CurrentMonth,t.Settings.CurrentYear,t.Settings.DepartmentId,t.Settings.LocationId,n);$.ajax({type:"GET",url:i,cache:!1,contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(n){if($(".se-pre-con").fadeOut(0),n&&n.ObjectId>0){var f=RBVH.Stada.WebPages.Utilities.GetValueByParam("Source"),r=RBVH.Stada.WebPages.Utilities.GetValueByParam("Mode"),u=RBVH.Stada.WebPages.Utilities.GetValueByParam("lang"),i=RBVH.Stada.WebPages.Utilities.String.format(t.Settings.ShiftImportReturnUrl,location.host,n.ObjectId,f);r&&(i=i+"&mode="+r);u&&(i=i+"&lang="+u);window.location=i}})}},OnBeginSaveData:function(){var n=this;$(n.Settings.ShaderCssClass).show();$(n.Settings.LoadPanelCssClass).show();n.ToggleSaveButton(!1)},OnEndSaveData:function(){var n=this;$(n.Settings.ShaderCssClass).hide();$(n.Settings.LoadPanelCssClass).hide();n.ToggleSaveButton(!0);n.Settings.EmployeeJsonArray=[];window.location=n.Settings.PrevURL},OnSaveData:function(){var n=this,i,t;n.Settings.View=="Approval"?(n.OnBeginSaveData(),t=n.SetMasterObject(),n.SaveShiftApproval(t)):(i=n.Settings.EmployeeJsonArray.length>0,n.CheckIsDirty()||(n.OnBeginSaveData(),t=n.SetMasterObject(),n.SaveShiftRequest(t,i)))},DisableControls:function(n){var t=this;$(t.Settings.MonthControlSelector).prop("disabled",!0);$(t.Settings.DepartmentControlSelector).prop("disabled",!0);$(t.Settings.ImportControlSelector).hide();$(t.Settings.FileSelector).prop("disabled",!0);n&&(t.Settings.ReadOnlyGrid=!0,t.ToggleSaveButton(!1))},TryLoadInformation:function(){var n=this,t;n.Settings.View=="Edit"?n.DisableControls(!1):n.Settings.View=="View"&&n.DisableControls(!0);n.Settings.Id&&(t=RBVH.Stada.WebPages.Utilities.String.format(n.Settings.ServiceUrls.ShiftRequestGet,location.host,n.Settings.Id),$.ajax({type:"GET",url:t,cache:!1,async:!1,contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(t){var e,i,r,f;n.Settings.View=="Approval"&&_rbvhContext&&_rbvhContext.EmployeeInfo&&_rbvhContext.EmployeeInfo.ADAccount.ID!=t.ApprovedBy.ID&&(e=RBVH.Stada.WebPages.Utilities.String.format(n.Settings.ServiceUrls.IsDelegated,location.host,t.ApprovedBy.ID,n.Settings.Id),$.ajax({type:"GET",url:e,cache:!1,async:!1,contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(t){t==!1&&(window.location=window.location.protocol+"//"+location.host+"/_layouts/15/AccessDenied.aspx");n.Settings.ApproverFullName=_rbvhContext.EmployeeInfo.FullName}));n.Settings.RequestDueDate=t.RequestDueDate;n.Settings.RequestExpired=t.RequestExpired;$(n.Settings.DepartmentControlSelector).prop("disabled",!0);$(n.Settings.DepartmentControlSelector).val(t.Department.Id);$(n.Settings.MonthControlSelector).val(t.Month+"/"+t.Year);n.Settings.CurrentMonth=t.Month;n.Settings.CurrentYear=t.Year;i=1;try{r=Functions.getConfigValue(n.Settings.Configurations,n.Settings.ConfigKey_ValidInputDate);r&&(i=parseInt(r))}catch(c){i=1}var u=new Date,h=u.getDate()+i,o=u.getMonth()+1,s=u.getYear()+1900;n.Settings.ReadOnlyGrid=!1;n.Settings.View=="View"?n.Settings.ReadOnlyGrid=!0:t.Year<s?n.Settings.ReadOnlyGrid=!0:t.Year==s&&(t.Month<o?n.Settings.ReadOnlyGrid=!0:t.Month==o&&h>20&&(n.Settings.ReadOnlyGrid=!0));n.Settings.DaysInMonth=new Date(t.Year,t.Month-1,0).getDate();n.Settings.ShiftManagementId=t.Id;n.Settings.ShiftManagementDataSource=t.ShiftManagementDetailModelList;n.Settings.Requester.Id=t.Requester.LookupId;n.Settings.Requester.Name=t.Requester.LookupValue;n.Settings.LocationId=t.Location.LookupId;n.Settings.LocationName=t.Location.LookupValue;$(n.Settings.FactoryLocationControlSelector).html(t.Location.LookupValue);n.Settings.Requester.DepartmentId=t.Department.LookupId;n.Settings.DepartmentId=t.Department.Id;n.Settings.ApprovedBy=t.ApprovedBy;n.Settings.ModifiedBy=t.ModifiedBy;$(n.Settings.ApprovedByControlSelector).html(t.ApprovedBy.FullName);f=t.AdditionalUser;f!=null&&$(n.Settings.LatestApprovedByControlSelector).html(f[0].FullName);$(n.Settings.MonthControlSelector).prop("disabled",!0)}))},PopulateData:function(){this.PopulateDepartment();this.TryLoadInformation();this.PopulatePersonalInformation();this.CalculateDateRange();this.GetNonWorkingDays();this.PopulateLeavesByDepartment();this.PopulateShiftTime();this.PopulateGrid()},PopulateDepartment:function(){var n=this,t=_spPageContextInfo.currentLanguage,i=_rbvhContext.EmployeeInfo!=null?_rbvhContext.EmployeeInfo.FactoryLocation.LookupId:2,r=RBVH.Stada.WebPages.Utilities.String.format(n.Settings.ServiceUrls.DepartmentList,location.host,t,i);$(n.Settings.DepartmentControlSelector).attr("disabled",!1);$(n.Settings.DepartmentControlSelector).empty();$.ajax({type:"GET",url:r,contentType:"application/json; charset=utf-8",dataType:"json",async:!1,success:function(t){$(t).each(function(){$(n.Settings.DepartmentControlSelector).append($("<option>").attr("value",this.Id).text(this.DepartmentName))});n.Settings.DepartmentId=$(n.Settings.DepartmentControlSelector).val()}})},PopulateAdminRequester:function(){var n=this;SP.SOD.executeFunc("SP.js","SP.ClientContext",function(){var t=new SP.ClientContext.get_current,r=t.get_web(),i=t.get_web().get_currentUser();t.load(i);t.executeQueryAsync(function(){var r=i.get_id(),t=i.get_title();$(n.Settings.RequesterControlSelector).html(t);n.Settings.Requester={Id:r,Name:t,DepartmentId:$(n.Settings.DepartmentControlSelector).val()}},function(){})})},PopulatePersonalInformation:function(){var n=this,t=RBVH.Stada.WebPages.Utilities.String.format(n.Settings.ServiceUrls.UserInformation,location.host);$.ajax({type:"GET",url:t,contentType:"application/json; charset=utf-8",dataType:"json",async:!1,success:function(t){t&&(t.IsSystemAdmin==!0?(n.Settings.IsSystemAdmin=!0,n.PopulateDepartment(),n.PopulateAdminRequester()):(n.Settings.View!="Approval"&&!!n.Settings.Id==!1&&(n.Settings.Requester={Id:t.ID,Name:t.FullName,DepartmentId:t.Department.LookupId,LocationId:t.Location.LookupId},n.Settings.DepartmentId=t.Department.LookupId,n.Settings.LocationId=t.Location.LookupId,n.Settings.LocationName=t.Location.LookupValue,$(n.Settings.FactoryLocationControlSelector).html(t.Location.LookupValue),$(n.Settings.DepartmentControlSelector).val(t.Department.LookupId).change(),$(n.Settings.DepartmentControlSelector).prop("disabled",!0)),!!n.Settings.ApprovedBy.UserName==!1&&n.PopulateApprovedBy(t.ID)))}})},PopulateApprovedBy:function(n){var t=this,i=RBVH.Stada.WebPages.Utilities.String.format(t.Settings.ServiceUrls.Approvers,location.host,n);$.ajax({type:"GET",url:i,contentType:"application/json; charset=utf-8",dataType:"json",async:!1,success:function(n){n&&n.Approver2&&($(t.Settings.ApprovedByControlSelector).html(n.Approver2.FullLoginName),t.Settings.ApprovedBy.UserName=n.Approver2.LoginName,t.Settings.ApprovedBy.FullName=n.Approver2.FullLoginName)}})},PopulateLeavesByDepartment:function(){var n=this,t=RBVH.Stada.WebPages.Utilities.String.format(n.Settings.ServiceUrls.LeavesByDepartment,location.host,n.Settings.LocationId,n.Settings.DepartmentId,n.Settings.StartDateRange,n.Settings.EndDateRange);$.ajax({type:"GET",url:t,contentType:"application/json; charset=utf-8",dataType:"json",async:!1,success:function(t){t&&(n.Settings.LeavesByDepartmentArray=t)}})},PopulateShiftTime:function(){var n=this,t=RBVH.Stada.WebPages.Utilities.String.format(n.Settings.ServiceUrls.ShiftTimeList,location.host);$.ajax({type:"GET",url:t,contentType:"application/json; charset=utf-8",dataType:"json",async:!1,success:function(t){n.Settings.ShiftTimes=t.filter(function(n){return n.ShiftRequired==!0});n.Settings.ShiftTimeCodes=$.map(n.Settings.ShiftTimes,function(n){return n.Code})}})},PopulateGrid:function(){var n=this;n.ToggleSaveButton(!1);n.Settings.ShiftManagementId>0&&n.Settings.ShiftManagementDataSource.length>0?_rbvhContext&&_rbvhContext.EmployeeInfo&&_rbvhContext.EmployeeInfo.DepartmentPermission==="Administrators"&&_rbvhContext.EmployeeInfo.EmployeePosition.LookupValue==="Admin Dept"?n.ToggleExportButton(!0):n.ToggleExportButton(!1):n.ToggleExportButton(!1);n.BindShiftTimeField();n.BindGridColumns();n.Settings.View=="Approval";$(n.Settings.GridEmployeeControlSelector).jsGrid({width:"100%",height:"400px",headercss:"jsGridEmployeeHeader",editing:!n.Settings.ReadOnlyGrid,autoload:!0,noDataContent:"",onDataLoaded:function(){n.Settings.ShiftManagementDataSource=[];n.HighLightGrid();$(document).on("click",".jsgrid-row , .jsgrid-alt-row",function(){var c=$(this),t=$(this).prev(),u=1,f,l,i,a,r;try{f=Functions.getConfigValue(n.Settings.Configurations,n.Settings.ConfigKey_ValidInputDate);f&&(u=parseInt(f))}catch(v){u=1}var e=new Date,o=e.getDate()+u,s=e.getMonth()+1,h=e.getYear()+1900;if(h==n.Settings.CurrentYear&&s==n.Settings.CurrentMonth-1||h==n.Settings.CurrentYear-1&&s==12&&n.Settings.CurrentMonth==1){if(o>21)for(l=o-20,i=2;i<=l;i++)t.find("td:eq("+i+") input").attr("disabled",!0)}else if(h==n.Settings.CurrentYear&&s==n.Settings.CurrentMonth)for(a=n.Settings.DaysInMonth-20+o,r=2;r<=a;r++)t.find("td:eq("+r+") input").attr("disabled",!0);c.find("td.shift-time-valid, td.jsgrid-cell-half-day, td.jsgrid-cell-all-day").each(function(){var n=$(this).index();t.find("td:eq("+n+") input").attr("disabled",!0)});c.find("td.highlight").each(function(){var n=$(this).index();t.find("td:eq("+n+")").addClass("highlight-edit")});t.find("td input:enabled:not([readonly]):first").focus()});$(n.Settings.GridEmployeeControlSelector).on("keyup",".jsgrid-edit-row input",function(n){n.which==13||n.which==40||n.which==38?$(".jsgrid-update-button").click():n.which==27&&$(".jsgrid-cancel-edit-button").click()});$(n.Settings.GridEmployeeControlSelector).on("paste",".jsgrid-edit-row input",function(){var t=$("input:radio[name='grHotKey']:checked").val(),n;if(typeof t!="undefined"){if(n=this,$(n).parent().hasClass("highlight-edit"))return;t=="Month"&&setTimeout(function(){for(var r=$(n).val(),t=$(n).parent().next("td").not(".highlight-edit").find("input[type!=button]:enabled:not([readonly]):first"),i=$(n).parent().next("td").find("input[type!=button]:enabled:not([readonly]):first"),u=0;i.length>0;)t.length==0?t=i.parent().next("td").not(".highlight-edit").find("input[type!=button]:enabled:not([readonly]):first"):(t.val(r),t=t.parent().next("td").not(".highlight-edit").find("input[type!=button]:enabled:not([readonly]):first")),i=i.parent().next("td").find("input[type!=button]:enabled:not([readonly]):first"),u++},100);t=="Week"&&setTimeout(function(){for(var i=$(n).val(),t=$(n).parent().next("td").not(".highlight-edit").find("input[type!=button]:enabled:not([readonly]):first");t.length>0;)t.val(i),t=t.parent().next("td").not(".highlight-edit").find("input[type!=button]:enabled:not([readonly]):first")},100)}});$(window).keydown(function(n){if(n.which==13)return n.preventDefault(),!1});$(".jsgrid-grid-body").scroll(function(){n.UpdateColPos(2)});var i=1e3,t;$(document).on("mouseover","td.jsgrid-cell-all-day, td.jsgrid-cell-half-day",function(){var n=$(this);t=setTimeout(function(){var t=n.attr("data-leave-url");$("#leave-link").attr("href",t);$("#leave-dialog").dialog();$("#leave-link").off("click").on("click",function(){var n=$(this).attr("href");return window.open(n,"_blank"),setTimeout(function(){$("#leave-dialog").dialog("close")},1e3),!1});return!1},i)}).on("mouseout","td.jsgrid-cell-all-day, td.jsgrid-cell-half-day",function(){clearTimeout(t)})},rowClick:function(t){this._editingRow&&this.updateItem();var i=$(t.event.target);n.Settings.View=="Approval"?t.item.IsExisted&&this.editItem(i.closest("tr")):this.editItem(i.closest("tr"))},rowRenderer:function(t){var l=n.Settings.LeavesByDepartmentArray.filter(function(n){return n.EmployeeId==t.Employee.Id}),w=l.length>0&&l[0].Leaves.length>0,c,k='<td class="jsgrid-cell jsgrid-align-center" style="width: 100px;">'+t.Employee.EmployeeId+"<\/td>",d='<td class="jsgrid-cell" style="width: 150px;font-weight: bold;">'+t.Employee.FullName+"<\/td>",f,e,s,h,b;c=$("<tr>").append(k).append(d);var a,p="shift-time-invalid",v="shift-time-valid",i=p;for(f=n.Settings.BeginDate;f<=n.Settings.DaysInMonth;f++){i=p;e=t["ShiftTime"+f];e=e||{};var r=e.Code=="P"?"P":n.GetShiftTimeCodeById(e.Value),u=null,o="",y="";w&&(u=$.grep(l[0].Leaves,function(t){return t.Day==f&&$.inArray(f,n.Settings.NonWorkingDays)<0}),u.length==1&&(o=" jsgrid-cell-half-day ",u[0].AllDay==!0?(o=" jsgrid-cell-all-day ",i=v,r="P"):r||(r="HC"),y=u[0].ItemUrl));i=!e.Approved?i:v;a='<td class="jsgrid-cell jsgrid-align-center '+o+i+'" data-leave-url="'+y+'">'+r+"<\/td>";c.append(a)}for(s=1;s<=n.Settings.EndDate;s++){i=p;h=t["ShiftTime"+s];h=h||{};var r=h.Code=="P"?"P":n.GetShiftTimeCodeById(h.Value),u=null,o="",y="";w&&(u=$.grep(l[0].Leaves,function(t){return t.Day==s&&$.inArray(s,n.Settings.NonWorkingDays)<0}),u.length==1&&(o=" jsgrid-cell-half-day ",u[0].AllDay==!0?(o=" jsgrid-cell-all-day ",i=v,r="P"):r||(r="HC"),y=u[0].ItemUrl));i=!h.Approved?i:v;a='<td class="jsgrid-cell jsgrid-align-center '+o+i+'" data-leave-url="'+y+'">'+r+"<\/td>";c.append(a)}return b='<td class="jsgrid-cell" style="width: 60px;"><\/td>',c.append(b),c},controller:{loadData:function(){var t={},r,u,f,e,i;if(n.Settings.View=="Approval"){if(n.Settings.Id>0&&n.Settings.ShiftManagementDataSource.length>0)return n.Settings.GridBeforeEdit=JSON.stringify(n.Settings.ShiftManagementDataSource),n.Settings.EmployeeJsonArray=n.Settings.ShiftManagementDataSource,n.ToggleApprovalButton(),n.Settings.ShiftManagementDataSource}else if(n.Settings.Id>0){if(n.Settings.ShiftManagementDataSource.length>0)return n.Settings.GridBeforeEdit=JSON.stringify(n.Settings.ShiftManagementDataSource),n.Settings.ShiftManagementDataSource}else return i=$.Deferred(),f=RBVH.Stada.WebPages.Utilities.String.format(n.Settings.ServiceUrls.ShiftRequestList,location.host),u=n.Settings.CurrentMonth,r=n.Settings.CurrentYear,e=n.Settings.DepartmentId,locationId=n.Settings.LocationId,t={},t.Month=u.toString(),t.Year=r.toString(),t.DepartmentId=e.toString(),t.LocationId=locationId.toString(),$.ajax({type:"POST",url:f,cache:!1,data:JSON.stringify(t),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(t){n.Settings.GridBeforeEdit=JSON.stringify(t.ShiftManagementDetailModelList);n.Settings.ShiftManagementId=t.Id;i.resolve(t.ShiftManagementDetailModelList)}),i.promise()},updateItem:function(t){n.Settings.ItemBeforeEdit!=null&&JSON.stringify(n.Settings.ItemBeforeEdit)!=JSON.stringify(t)&&(n.FilterEmployeeList(t.Employee.Id),n.Settings.EmployeeJsonArray.push(t))},deleteItem:function(){}},onItemEditing:function(t){n.ToggleSaveButton(!1);n.Settings.ItemBeforeEdit=t.item;setTimeout(function(){n.UpdateColPos(2)},1)},onItemUpdated:function(){n.ToggleSaveButton();n.HighLightGrid();n.UpdateColPos(2)},onItemEditCancelling:function(){n.ToggleSaveButton()},onRefreshed:function(){n.UpdateColPos(2)},fields:n.Settings.Fields})},ToggleSaveButton:function(n){typeof n!="undefined"?n?($(this.Settings.SaveControlSelector).prop("disabled",!1),$(this.Settings.SaveControlSelector).removeClass("disable")):($(this.Settings.SaveControlSelector).prop("disabled",!0),$(this.Settings.SaveControlSelector).addClass("disable")):this.Settings.View=="Approval"?this.ToggleApprovalButton():this.CheckIsDirty()==!0?($(this.Settings.SaveControlSelector).prop("disabled",!0),$(this.Settings.SaveControlSelector).addClass("disable")):($(this.Settings.SaveControlSelector).prop("disabled",!1),$(this.Settings.SaveControlSelector).removeClass("disable"))},ToggleExportButton:function(n){typeof n!="undefined"?n?($(this.Settings.ExportControlSelector).prop("disabled",!1),$(this.Settings.ExportControlSelector).removeClass("disable")):($(this.Settings.ExportControlSelector).prop("disabled",!0),$(this.Settings.ExportControlSelector).addClass("disable")):this.CheckIsDirty()==!0?($(this.Settings.ExportControlSelector).prop("disabled",!0),$(this.Settings.ExportControlSelector).addClass("disable")):($(this.Settings.ExportControlSelector).prop("disabled",!1),$(this.Settings.ExportControlSelector).removeClass("disable"))},CheckIsDirty:function(){if(this.Settings.GridBeforeEdit!=null){var n=JSON.stringify($(this.Settings.GridEmployeeControlSelector).jsGrid("option","data"));if(this.Settings.GridBeforeEdit!=n)return!1}return!0},InitControls:function(){var n=this;$(n.Settings.MonthControlSelector).datepicker({viewMode:"months",minViewMode:"months",format:"mm/yyyy",autoclose:!0});$(n.Settings.ImportControlSelector).prop("disabled",!0);$(n.Settings.ImportControlSelector).addClass("disable");$("#ShiftFileUpload").val("")},SetDefaultValue:function(){var n=this,t=1,i;try{i=Functions.getConfigValue(n.Settings.Configurations,n.Settings.ConfigKey_ValidInputDate);i&&(t=parseInt(i))}catch(o){t=1}var r=new Date,e=r.getDate()+t,u=r.getMonth(),f=r.getYear()+1900;n.Settings.DaysInMonth=new Date(f,u,0).getDate();n.Settings.CurrentMonth=u+1;n.Settings.CurrentYear=f;$(n.Settings.MonthControlSelector).val(u+1+"/"+f);e>20&&(n.Settings.ReadOnlyGrid=!0)},BindGridColumns:function(){var n=this,t,i;for(jsGrid.fields.custShiftTimeField=n.Settings.Grid.CustomFields.ShiftTimeField,n.Settings.Fields=[{name:"Employee.EmployeeId",title:n.Settings.Grid.Titles.GridColumn_EmployeeId,width:100,validate:"required",readOnly:!0,align:"center"},{name:"Employee.FullName",title:n.Settings.Grid.Titles.GridColumn_EmployeeName,width:150,validate:"required"},],t=n.Settings.BeginDate;t<=n.Settings.DaysInMonth;t++)i="ShiftTime"+t+".Value",n.Settings.Fields.push({name:i,title:t,type:"custShiftTimeField",align:"center",width:50});for(t=1;t<=n.Settings.EndDate;t++)i="ShiftTime"+t+".Value",n.Settings.Fields.push({name:i,title:t,type:"custShiftTimeField",align:"center",width:50});n.Settings.Fields.push({type:"control"})},BindShiftTimeField:function(){var n=this;n.Settings.Grid.CustomFields.ShiftTimeField=function(n){jsGrid.Field.call(this,n)};n.Settings.Grid.CustomFields.ShiftTimeField.prototype=new jsGrid.Field({itemTemplate:function(n){return n},insertTemplate:function(){return this._insertPicker=$("<input>").autocomplete({source:n.Settings.ShiftTimeCodes})},editTemplate:function(t){return this._editPicker=$("<input>").autocomplete({source:n.Settings.ShiftTimeCodes}).val(n.GetShiftTimeCodeById(t))},insertValue:function(){return this._insertPicker.val()},editValue:function(){return n.GetShiftTimeIdByCode(this._editPicker.val())}})},HighLightGrid:function(){for(var n=this,i=n.Settings.NonWorkingDays,r,t=0;t<i.length;t++)i[t]>=n.Settings.BeginDate&&i[t]<=n.Settings.MaxDate?(r=parseInt(i[t])-n.Settings.BeginDate+n.Settings.StartIndex,$(".jsgrid-alt-row").find("td:eq("+r+")").addClass("highlight"),$(".jsgrid-row").find("td:eq("+r+")").addClass("highlight")):i[t]>=1&&i[t]<=n.Settings.EndDate&&(r=parseInt(i[t])+(n.Settings.Start1StDateIndex-(n.Settings.MaxDate-n.Settings.DaysInMonth))-1,$(".jsgrid-alt-row").find("td:eq("+r+")").addClass("highlight"),$(".jsgrid-row").find("td:eq("+r+")").addClass("highlight"))},GetHighlightCSSClass:function(n,t){if(n)if(n=="NM1"){if(this.Settings.NonWorkingDaysNM1.indexOf(t)>=0)return"highlight-location1"}else if(n=="NM2"&&this.Settings.NonWorkingDaysNM2.indexOf(t)>=0)return"highlight-location2";return""},GetShiftTimeIdByCode:function(n){if(n!=""){var t="";return $.each(this.Settings.ShiftTimes,function(i,r){if(r.Code==n){t=r.Id;return}}),t+""}return""},GetShiftTimeCodeById:function(n){if(n!=""){var t="";return $.each(this.Settings.ShiftTimes,function(i,r){if(r.Id==n){t=r.Code;return}}),t}return""},FilterEmployeeList:function(n){var t=this;t.Settings.EmployeeJsonArray=t.Settings.EmployeeJsonArray.filter(function(t){return t.Employee.Id!=n})},GetNonWorkingDays:function(){var n=this,t=RBVH.Stada.WebPages.Utilities.String.format(n.Settings.ServiceUrls.CalendarList,location.host,n.Settings.StartDateRange,n.Settings.EndDateRange);t=n.Settings.IsSystemAdmin?t+'/""':t+"/"+n.Settings.LocationId;$.ajax({type:"GET",url:t,contentType:"application/json; charset=utf-8",dataType:"json",async:!1,success:function(t){n.Settings.NonWorkingDays=[];n.Settings.NonWorkingDays=t.filter(function(t){return t.Location==n.Settings.LocationName}).map(function(n){return n.Day})}})},SetMasterObject:function(){var t=this,n={};return n.Id=t.Settings.ShiftManagementId,n.Month=t.Settings.CurrentMonth.toString(),n.Year=t.Settings.CurrentYear.toString(),n.Department={},n.Department.Id=t.Settings.DepartmentId.toString(),n.Location={},n.Location.LookupId=t.Settings.LocationId.toString(),n.ShiftManagementDetailModelList=[],n.Requester={},n.Requester.LookupId=t.Settings.Requester.Id,n.Requester.LookupValue=t.Settings.Requester.Name,n.ApprovedBy=t.Settings.ApprovedBy||{},n.ShiftManagementDetailModelList=[],n.ApproverFullName=t.Settings.ApproverFullName!=""?t.Settings.ApproverFullName:n.ApprovedBy.FullName,n},SaveShiftRequest:function(n){var t=this,i=RBVH.Stada.WebPages.Utilities.String.format(t.Settings.ServiceUrls.ShiftManagementMasterDetailInsert,location.host);n.ShiftManagementDetailModelList=t.Settings.EmployeeJsonArray;$.ajax({type:"POST",url:i,data:JSON.stringify(n),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(n){n&&n.Code>0&&console.log(n.Message);t.OnEndSaveData();window.location=t.Settings.PrevURL})},SaveShiftApproval:function(n){var f=this,s=[],r={},e,h,v,c,y,u,i,l,a,t,o;for(r.Year=n.Year,r.Month=n.Month,r.ShiftManagementId=n.Id,r.DepartmentId=n.Department.Id,r.LocationId=n.Location.LookupId,r.EmployeeNameList=[],r.ApproverFullName=n.ApproverFullName,e="",h=f.Settings.ModifiedBy,!h||(e=h.UserName),_rbvhContext&&_rbvhContext.EmployeeInfo&&_rbvhContext.EmployeeInfo.ADAccount&&_rbvhContext.EmployeeInfo.ADAccount.UserName&&(n.AdditionalUser=[],v={UserName:_rbvhContext.EmployeeInfo.ADAccount.UserName,ID:_rbvhContext.EmployeeInfo.ADAccount.ID},n.AdditionalUser.push(v)),r.ModifiedBy=e,n.ModifiedByString=e,c=performance.now(),y=RBVH.Stada.WebPages.Utilities.String.format(f.Settings.ServiceUrls.ShiftManagementDetailApprove,location.host),u=0;u<f.Settings.EmployeeJsonArray.length;u++)if(i=f.Settings.EmployeeJsonArray[u],l=[],i.IsExisted==!0){for(a=!1,t=0,t=1;t<=31;t++)i["ShiftTime"+t].Value>0&&i["ShiftTime"+t].Approved==!1?(a=!0,i.NewApproval=!0,i["ShiftTime"+t].Approved=!0,f.Settings.NonWorkingDays.indexOf(t)>=0&&(o={},o.Day=t,o.ShiftTimeId=i["ShiftTime"+t].Value,l.push(o),i["ShiftTime"+t].Day=t)):i["ShiftTime"+t].Value<=0&&i["ShiftTime"+t].Approved==!1;a===!0&&r.EmployeeNameList.push(i.Employee.FullName);i.ApprovalDays=l;s.push(i)}var p=performance.now(),w=s.length;for(c=performance.now(),u=0;u<w;u++)n.ShiftManagementDetailModelList.push(s[u]);$.ajax({type:"POST",url:y,data:JSON.stringify(n),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(n){if(n.Code==0){p=performance.now();c=performance.now();var t=RBVH.Stada.WebPages.Utilities.String.format(f.Settings.ServiceUrls.ShiftManagementSendAdminApprovalEmail,location.host);$.ajax({type:"POST",url:t,cache:!1,data:JSON.stringify(r),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(){p=performance.now();f.OnEndSaveData()})}else n&&n.Code==2&&(alert(n.Message),window.location.reload())})},ToggleApprovalButton:function(){for(var r,t,n=this,u=n.Settings.EmployeeJsonArray.filter(function(n){return n.IsExisted==!0}),i=0;i<u.length;i++)for(r=u[i],t=0,t=1;t<=31;t++)if(r["ShiftTime"+t].Value>0&&r["ShiftTime"+t].Approved==!1){n.Settings.RequestExpired===!0?(errMsg=decodeURI(n.Settings.RequestExpiredMsgFormat),errMsg=RBVH.Stada.WebPages.Utilities.String.format(errMsg,n.Settings.RequestDueDate),RBVH.Stada.WebPages.Utilities.GUI.showRequestExpired(n.Settings.ErrorMsgContainerSelector,n.Settings.ErrorMsgSelector,errMsg),n.ToggleSaveButton(!1)):n.ToggleSaveButton(!0);return}},GetApprovalDays:function(n){var t=[];for(j=1;j<=31;j++)n["ShiftTime"+j].Value>0&&n["ShiftTime"+j].Approved==!1&&t.push(j)},CreateEmployeeObject:function(){for(var n,t,i=[],r=0;r<=5;r++){for(n={},n.Employee={},n.Employee.EmployeeId="19024",n.Employee.FullName="Chau Pham",n.Employee.Id=157,t=1;t<=31;t++)n["ShiftTime"+t]={},n["ShiftTime"+t].Value="1",n["ShiftTime"+t].Approved=!1,n["ShiftTime"+t].Day=0;i.push(n)}return i},CalculateDateRange:function(){var n=this,t=RBVH.Stada.WebPages.Utilities.String.padDate(n.Settings.CurrentMonth-1),i=n.Settings.CurrentYear;n.Settings.CurrentMonth==1&&(t=12,i=n.Settings.CurrentYear-1);var r=RBVH.Stada.WebPages.Utilities.String.format(n.Settings.ISODateFormat,t,"21",i),u=n.Settings.CurrentYear,f=RBVH.Stada.WebPages.Utilities.String.padDate(n.Settings.CurrentMonth),e=RBVH.Stada.WebPages.Utilities.String.format(n.Settings.ISODateFormat,f,"20",u);n.Settings.StartDateRange=r;n.Settings.EndDateRange=e},UpdateColPos:function(n){var t=$(".jsgrid-grid-body").scrollLeft()<$(".jsgrid-grid-body .jsgrid-table").width()-$(".jsgrid-grid-body").width()+16?$(".jsgrid-grid-body").scrollLeft():$(".jsgrid-grid-body .jsgrid-table").width()-$(".jsgrid-grid-body").width()+16;$(".jsgrid-header-row th:nth-child(-n+"+n+"), .jsgrid-filter-row td:nth-child(-n+"+n+"), .jsgrid-insert-row td:nth-child(-n+"+n+"), .jsgrid-grid-body tr td:nth-child(-n+"+n+")").css({position:"relative",left:t})}};