RBVH.Stada.javascript.common.NamespaceManager.register("RBVH.Stada.WebPages.pages");RBVH.Stada.WebPages.pages.Overview=function(n){this.Protocol=window.location.protocol;this.Settings={ServiceUrls:{DepartmentList:this.Protocol+"//{0}/_vti_bin/Services/Department/DepartmentService.svc/GetDepartmentsByLcid/{1}/{2}",ModuleList:this.Protocol+"//{0}/_vti_bin/Services/Common/CommonService.svc/GetModules/{1}",TaskOverview:this.Protocol+"//{0}/_vti_bin/Services/Common/CommonService.svc/GetTaskOverview/{1}/{2}/{3}",TaskList:this.Protocol+"//{0}/_vti_bin/Services/Common/CommonService.svc/GetTaskByCondition/{1}/{2}/{3}/{4}"},ApprovalStatus:[{Name:"",Id:0},{Name:"In-Progress",Id:1},{Name:"Rejected",Id:2},{Name:"Approved",Id:3},{Name:"In-Process",Id:4},{Name:"Completed",Id:5},],ApprovalStatusInVN:[{Name:"",Id:0},{Name:"Đang chờ duyệt",Id:1},{Name:"Từ chối",Id:2},{Name:"Đã duyệt",Id:3},{Name:"Đang thực hiện",Id:4},{Name:"Hoàn thành",Id:5},],Condition:{WaitingApproval:"WaitingApproval",WaitingApprovalToday:"WaitingApprovalToday",InProcess:"InProcess",ApprovedToday:"ApprovedToday"},Data:{LCID:0,ApprovalStatus:[],Departments:[],Modules:[],UserInfoId:0,UserADId:0,LocationId:2,FullName:"System Account",Position:"",IsBOD:!1,Condition:""},Grid:{DataSource:[],ShaderCssClass:".jsgrid-load-shader",LoadPanelCssClass:".jsgrid-load-panel",LoadedData:!1}};$.extend(!0,this.Settings,n);this.Initialize()};RBVH.Stada.WebPages.pages.Overview.prototype={Initialize:function(){var n=this;$(document).ready(function(){n.InitDefaultValue();n.RegisterEvents();n.GetOverviewData().then(function(t){n.PopulateChart(t)});n.PopulateGridFilter(n.PopulateGrid)})},RegisterEvents:function(){$("h2.conner .show-hide").click(function(n){n.stopPropagation();$(this).parent().parent().find(".grid-content").toggle();var t=$(this);t.hasClass("s-expand")?(t.removeClass("s-expand"),t.addClass("s-collapse"),$(window).trigger("resize")):(t.removeClass("s-collapse"),t.addClass("s-expand"),$(window).trigger("resize"))})},InitDefaultValue:function(){this.Settings.Data.LCID=_spPageContextInfo.currentLanguage;_rbvhContext.EmployeeInfo!=null&&(this.Settings.Data.UserInfoId=_rbvhContext.EmployeeInfo.ID,this.Settings.Data.UserADId=_rbvhContext.EmployeeInfo.ADAccount.ID,this.Settings.Data.LocationId=_rbvhContext.EmployeeInfo.FactoryLocation.LookupId,this.Settings.Data.FullName=_rbvhContext.EmployeeInfo.FullName,this.Settings.Data.Position=_rbvhContext.EmployeeInfo.EmployeePosition.LookupValue,this.Settings.Data.IsBOD=this.Settings.Data.Position=="Board of Director")},PopulateDepartments:function(){var n=this,t=_spPageContextInfo.currentLanguage,i=RBVH.Stada.WebPages.Utilities.String.format(n.Settings.ServiceUrls.DepartmentList,location.host,t,n.Settings.Data.LocationId);return $.ajax({type:"GET",url:i,contentType:"application/json; charset=utf-8",dataType:"json"})},PopulateModules:function(){var n=this,t=_spPageContextInfo.currentLanguage,i=RBVH.Stada.WebPages.Utilities.String.format(n.Settings.ServiceUrls.ModuleList,location.host,t);return $.ajax({type:"GET",url:i,contentType:"application/json; charset=utf-8",dataType:"json"})},PopulateGrid:function(){function t(n,t){return $.grep(n,function(n){return(!t.RequesterName||n.RequesterName.indexOf(t.RequesterName)>-1)&&(!t.DepartmentId||n.DepartmentId==t.DepartmentId)&&(!t.ModuleId||n.ModuleId==t.ModuleId)&&(!t.Description||n.Description.indexOf(t.Description)>-1)&&(!t.CreatedDate||n.CreatedDate.indexOf(t.CreatedDate)>-1)&&(!t.DueDate||n.DueDate.indexOf(t.DueDate)>-1)&&(!t.ApprovalStatusId||n.ApprovalStatusId==t.ApprovalStatusId)})}var n=this;$(n.Settings.Grid.Selector).jsGrid({height:"100%",width:"100%",filtering:!0,sorting:!0,paging:!0,autoload:!0,pageSize:20,pageButtonCount:5,pagerFormat:n.Settings.Grid.PagerFormat,pagePrevText:"<",pageNextText:">",pageFirstText:"<<",pageLastText:">>",noDataContent:n.Settings.Grid.EmptyDataTitle,loadMessage:n.Settings.Grid.LoadMessageTitle,controller:{loadData:function(i){if(n.Settings.Data.Condition=="")return[];if(n.Settings.Grid.LoadedData)return t(n.Settings.Grid.DataSource,i);var r=RBVH.Stada.WebPages.Utilities.String.format(n.Settings.ServiceUrls.TaskList,location.host,n.Settings.Data.Condition,n.Settings.Data.UserADId,n.Settings.Data.UserInfoId,n.Settings.Data.FullName);return $.ajax({type:"GET",url:r,contentType:"application/json; charset=utf-8",dataType:"json",cache:!1,success:function(t){return $(n.Settings.Grid.ShaderCssClass).hide(),$(n.Settings.Grid.LoadPanelCssClass).hide(),n.Settings.Grid.DataSource=t,n.Settings.Grid.LoadedData=!0,n.Settings.Grid.DataSource}})}},fields:[{name:"ItemApprovalUrl",type:"text",width:50,filtering:!1,align:"center",title:"#",itemTemplate:function(n){var t=$("<a>").attr("href",n).attr("target","_blank"),i=$("<i>").attr("class","fa fa-eye");return t.append(i),$("<div>").append(t)}},{name:"ModuleId",type:"select",title:n.Settings.Grid.Columns.Title.Module,width:"12%",items:n.Settings.Data.Modules,valueField:"ID",textField:"Name",align:"left"},{name:"RequesterName",type:"text",title:n.Settings.Grid.Columns.Title.Requester,width:"12%",align:"left"},{name:"DepartmentId",type:"select",title:n.Settings.Grid.Columns.Title.Department,width:"12%",items:n.Settings.Data.Departments,valueField:"Id",textField:"DepartmentName",align:"left",filtering:n.Settings.Data.IsBOD},{name:"Description",type:"text",title:n.Settings.Grid.Columns.Title.Description,width:"auto",align:"left"},{name:"ApprovalStatusId",type:"select",title:n.Settings.Grid.Columns.Title.ApprovalStatus,width:"12%",items:n.Settings.Data.ApprovalStatus,valueField:"Id",textField:"Name",align:"center"},{name:"CreatedDate",type:"text",title:n.Settings.Grid.Columns.Title.CreatedDate,width:"12%",align:"center"},{name:"DueDate",type:"text",title:n.Settings.Grid.Columns.Title.DueDate,width:"12%",align:"center"},{type:"control",modeSwitchButton:!1,editButton:!1,deleteButton:!1}],onDataLoaded:function(){$("tr.jsgrid-row > td:nth-child(6), tr.jsgrid-alt-row > td:nth-child(6)").each(function(){var n=$(this),t=RBVH.Stada.WebPages.Utilities.GUI.generateItemStatus(n.html());n.html(t)})}})},PopulateChart:function(n){var t=this,i=["#888d91","#c1140b","#db1ed2","#5cb85c"],u=new Highcharts.chart("container",{chart:{type:"column",events:{load:function(){$(t.Settings.Chart.ShaderSelector).hide();$(t.Settings.Chart.LoaderSelector).hide()}}},xAxis:{categories:[t.Settings.Chart.Columns.Title.WaitingApprovalTitle,t.Settings.Chart.Columns.Title.WaitingApprovalTodayTitle,t.Settings.Chart.Columns.Title.InProcessTitle,t.Settings.Chart.Columns.Title.ApprovedTodayTitle],labels:{style:{color:"#575c60",font:'14px "Helvetica Neue",Helvetica,Arial,sans-serif'}}},title:{text:"",style:{fontSize:"2.77em",fontFamily:'"Helvetica Neue",Helvetica,Arial,sans-serif'}},yAxis:{allowDecimals:!1,title:{text:t.Settings.Chart.Columns.Title.LeftColumnTitle},labels:{style:{color:"#575c60",font:'14px "Helvetica Neue",Helvetica,Arial,sans-serif'}}},tooltip:{formatter:function(){return"<b>"+this.series.name+"<\/b><br/>"+this.point.y+" "+this.point.name.toLowerCase()}},plotOptions:{series:{cursor:"pointer",point:{events:{click:function(){var n,i;$(t.Settings.Grid.ShaderCssClass).show();$(t.Settings.Grid.LoadPanelCssClass).show();$(t.Settings.Grid.TaskListTitleSelector).html(" - "+this.category);n=$(t.Settings.Grid.Selector).data("JSGrid");n!=null&&(i=n._createFilterRow(),n._filterRow.replaceWith(i),n._filterRow=i);this.category==t.Settings.Chart.Columns.Title.WaitingApprovalTitle?t.Settings.Data.Condition=t.Settings.Condition.WaitingApproval:this.category==t.Settings.Chart.Columns.Title.WaitingApprovalTodayTitle?t.Settings.Data.Condition=t.Settings.Condition.WaitingApprovalToday:this.category==t.Settings.Chart.Columns.Title.InProcessTitle?t.Settings.Data.Condition=t.Settings.Condition.InProcess:this.category==t.Settings.Chart.Columns.Title.ApprovedTodayTitle&&(t.Settings.Data.Condition=t.Settings.Condition.ApprovedToday);t.Settings.Grid.LoadedData=!1;$(t.Settings.Grid.Selector).jsGrid("loadData")}}},dataLabels:{enabled:!0,crop:!1,overflow:"none",style:{fontSize:"13px"}}}},legend:{enabled:!1},series:[{name:t.Settings.Chart.Label,data:[{name:t.Settings.Chart.Columns.Title.WaitingApprovalTitle,y:n.TotalWaitingApproval,color:i[0]},{name:t.Settings.Chart.Columns.Title.WaitingApprovalTodayTitle,y:n.TotalWaitingApprovalToday,color:i[1]},{name:t.Settings.Chart.Columns.Title.InProcessTitle,y:n.TotalInProcess,color:i[2]},{name:t.Settings.Chart.Columns.Title.ApprovedTodayTitle,y:n.TotalApprovedToday,color:i[3]}]}],exporting:{enabled:!1},credits:{enabled:!1}}),r;$(window).resize(function(){clearTimeout(r);r=setTimeout(function(){var n=$("#container").parent().width();u.setSize(n,301,doAnimation=!0)},100)})},RebindChartColumnData:function(n,t){var r=$("#container").highcharts(),u=r.series[0].data,i;if(u!=null){i=u;switch(n){case this.Settings.Condition.WaitingApproval:i[0].y=t;break;case this.Settings.Condition.WaitingApprovalToday:i[1].y=t;break;case this.Settings.Condition.InProcess:i[2].y=t;break;case this.Settings.Condition.ApprovedToday:i[3].y=t}r.series[0].setData(i)}},GetOverviewData:function(){var n=this,i;$(n.Settings.Chart.ShaderSelector).show();var t=$(n.Settings.Chart.LoaderSelector).show(),r=t.outerWidth(),u=t.outerHeight();return t.css({marginTop:-u/2,marginLeft:-r/2}),i=RBVH.Stada.WebPages.Utilities.String.format(n.Settings.ServiceUrls.TaskOverview,location.host,n.Settings.Data.UserADId,n.Settings.Data.UserInfoId,n.Settings.Data.FullName),$.ajax({type:"GET",url:i,contentType:"application/json; charset=utf-8",dataType:"json",cache:!1})},PopulateGridFilter:function(n){var t=this;t.Settings.Data.ApprovalStatus=t.Settings.Data.LCID==1066?t.Settings.ApprovalStatusInVN:t.Settings.ApprovalStatus;$.when(t.PopulateDepartments(),t.PopulateModules()).done(function(i,r){if(t.Settings.Data.Departments=i[0],t.Settings.Data.Departments.unshift({DepartmentName:"",Id:0}),t.Settings.Data.Modules=r[0],t.Settings.Data.Modules.unshift({Name:"",Id:0}),typeof n=="function"){var u=n.bind(t);u()}})}};